<dom-module id="blog-posts">
    <template>
        <template is="dom-repeat" items="{{posts}}">
            <blog-preview post="{{item}}" selected="{{selected}}"></blog-preview>
        </template>
        </more-route-selector>
    </template>
    <script>
        Polymer({
            is: "blog-posts",
            properties: {
                posts: {type: Array, notify: true, value: [] },
                num_posts: { type: Number, value: 0, notify: true },
                source: {type: String,notify: true}
            },
            ready: function(){
                //fetch data, in this case... it's sample data.
                //this.getPosts(); //Commented out so the page will load faster than the 6 seconds it takes to default on the ajax requests
                console.log("blog-posts source: " + this.source);
                if (this.source)
                    this.getPostCount();
                else
                    console.log("source had a problem: " + this.source);
                //this is here for the time while I get a backend setup
                if (this.num_posts == 0){
                    var data = {
                        title: "This is filler!",
                        date: "DATE",
                        summary: "I am still working on finding some spare equipment to run the back end on.  Sorry for the inconvinience.",
                        body: "It's quite sad when a developer cannot find hardware to run their code on.  I will remedy this shortly.  In the meantime, please enjoy the rest of the site.  Most of it works, even if it's test data!",
                        image: "../images/post-headers/post_1.png",
                        id: 1
                    }
                    this.push("posts", data);
                    var dat = {
                        title: "This is a second filler!",
                        date: "DATE",
                        summary: "I am still working on finding some spare equipment to run the back end on.  Sorry for the inconvinience.",
                        body: "It's quite sad when a developer cannot find hardware to run their code on.  I will remedy this shortly.  In the meantime, please enjoy the rest of the site.  Most of it works, even if it's test data!",
                        image: "../images/post-headers/post_1.png",
                        id: 2
                    }
                    this.push("posts", dat);
                }
            },
            getPosts: function(){
                //return test data... ideally this is a temporary thing.
                console.log("Blog-Posts source before post_get: " + this.source);
                for (var i = 1; i <= post_count; ++i){
                    $.ajax({
                        context: this,
                        type: "GET",
                        url: this.source + "?type=single&postID=" + i,
                        dataType: "json",
                        headers: {
                            'Access-Control-Allow-Headers': 'Content-Type, Access-Control-Allow-Headers'
                        },
                        timeout: 500
                    }).done(function(data){
                        this.push("posts", data);
                    });
                } 
            },
            getPostCount: function(){
                console.log("Blog-Posts source before count: " + this.source);
                $.ajax({
                    context: this,
                    type: "GET",
                    url: this.source + "?type=count",
                    dataType: "json",
                    headers: {
                        'Access-Control-Allow-Headers': 'Content-Type, Access-Control-Allow-Headers'
                    },
                    timeout: 500,
                    tracker: Number
                }).done(function(data){
                    this.set("num_posts", data.count);
                    this.getPosts();
                })
            }
        });
    </script>
</dom-module>